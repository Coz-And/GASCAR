@page "/ricarica"
@page "/charging"
@using GASCAR.Web.Services
@using GASCAR.Web.Models
@implements IDisposable

@inject ApiService Api
@inject NavigationManager Nav
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">‚ö° Ricarica</h2>
        <a href="/dashboard" class="btn btn-secondary">‚Üê Torna alla Dashboard</a>
    </div>

    <!-- Info Box -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-radius: 8px; border-left: 4px solid #0066cc;">
        <h5 style="color: #003366;">‚ÑπÔ∏è Come funziona</h5>
        <p style="color: #003366; margin: 0;">Seleziona una colonnina disponibile e avvia la ricarica della tua auto. Il sistema monitora il processo in tempo reale.</p>
    </div>

    @if (currentCharging != null)
    {
        <div class="alert alert-success" style="padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
            <h5 style="color: #155724; margin-top: 0;">‚úÖ Ricarica Attiva!</h5>
            <div style="color: #155724; margin-bottom: 15px;">
                <p><strong>Auto:</strong> @currentCharging.CarId</p>
                <p><strong>Colonnina:</strong> @(currentCharging.StationId == 0 ? "-" : currentCharging.StationId)</p>
                <p><strong>Fine stimata:</strong> @(currentCharging.EndTime?.ToString("dd/MM/yyyy HH:mm") ?? "-")</p>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-danger" @onclick="StopCharging" style="padding: 10px; font-weight: bold; font-size: 1.1em;">
                    ‚èπÔ∏è Arresta Ricarica
                </button>
            </div>
        </div>
    }

    <!-- Selezione Colonnina - SEMPRE VISIBILE -->
    <div class="mb-4">
        <h5 style="color: #333;">üîå Colonnine Disponibili</h5>
        @if (stations == null)
        {
            <p style="color: #666;">Caricamento colonnine...</p>
        }
        else if (stations.Count == 0)
        {
            <div style="padding: 15px; background-color: #ffebee; border-radius: 5px; border-left: 4px solid #f44336;">
                <p style="color: #c62828; margin: 0;">‚ùå Nessuna colonnina disponibile al momento.</p>
            </div>
            <button class="btn btn-outline-primary mt-2" @onclick="ReloadStations">Ricarica colonnine</button>
        }
        else
        {
            <div class="row">
                @foreach (var station in stations)
                {
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div style="
                            padding: 15px;
                            border: 2px solid @(selectedStationId == station.Id ? "#4caf50" : "#ddd");
                            border-radius: 8px;
                            cursor: @(station.IsOccupied ? "not-allowed" : "pointer");
                            background-color: @(selectedStationId == station.Id ? "#f1f8e9" : (station.IsOccupied ? "#f5f5f5" : "#fff"));
                            opacity: @(station.IsOccupied ? "0.7" : "1");
                            transition: all 0.3s ease;
                        "
                             @onclick="() => SelectStation(station)">
                            
                            <div style="color: #1976d2; font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">
                                üìç @(string.IsNullOrWhiteSpace(station.Name) ? $"Colonnina #{station.Id}" : station.Name)
                            </div>

                            <div style="color: #424242; margin-bottom: 8px;">
                                <strong style="color: #333;">Indirizzo:</strong> @(string.IsNullOrEmpty(station.Address) ? "Non specificato" : station.Address)
                            </div>

                            <div style="
                                padding: 8px;
                                border-radius: 5px;
                                margin-bottom: 8px;
                                @(!station.IsOccupied ? "background-color: #c8e6c9; color: #2e7d32;" : "background-color: #ffccbc; color: #d84315;")
                            ">
                                <strong>Stato:</strong>
                                @if (!station.IsOccupied)
                                {
                                    <span>‚úÖ Disponibile</span>
                                }
                                else
                                {
                                    <span>‚è≥ Occupata</span>
                                }
                            </div>

                            @if (selectedStationId == station.Id)
                            {
                                <div style="padding: 8px; background-color: #4caf50; color: white; border-radius: 5px; text-align: center; font-weight: bold;">
                                    ‚úì Selezionata
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Selezione Auto - Visibile solo se c'√® una colonnina selezionata -->
    @if (selectedStationId > 0)
    {
        @if (cars == null)
        {
            <p style="color: #666;">Caricamento auto...</p>
        }
        else if (cars.Count == 0)
        {
            <div style="padding: 15px; background-color: #fff3cd; border-radius: 5px; border-left: 4px solid #ff9800;">
                <p style="color: #856404; margin: 0;">‚ùå Nessuna auto registrata. Aggiungi un'auto nel tuo profilo.</p>
            </div>
        }
        else
        {
            <div class="mb-4">
                <label class="form-label" style="color: #333; font-weight: bold;">Seleziona Auto da Ricaricare:</label>
                <select class="form-control" @onchange="SelectCar" value="@selectedCarId" style="font-size: 1em; padding: 10px; border: 2px solid #007bff;">
                    <option value="0">-- Scegli un'auto --</option>
                    @foreach (var car in cars)
                    {
                        <option value="@car.Id">@car.Model (@car.CurrentChargePercent%)</option>
                    }
                </select>
            </div>

            @if (selectedCarId > 0 && selectedCar != null)
            {
                <!-- Informazioni Auto Selezionata -->
                <div style="padding: 15px; background-color: #e8f5e9; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <h6 style="color: #2e7d32; margin-top: 0;">‚úÖ Auto Selezionata</h6>
                    <div style="color: #2e7d32;">
                        <p><strong>Modello:</strong> @selectedCar.Model</p>
                        <p><strong>Carica Attuale:</strong> @selectedCar.CurrentChargePercent%</p>
                        <p><strong>Capacit√† Batteria:</strong> @selectedCar.BatteryCapacityKw kWh</p>
                    </div>
                </div>
            }
        }
    }
    else
    {
        <div class="alert alert-warning">
            üëÜ Seleziona prima una colonnina dalla mappa o dalla lista sopra
        </div>
    }

    <!-- Pulsante Avvia Ricarica -->
    @if (!requested && currentCharging == null)
    {
        <div class="mb-4">
            <button @onclick="Request"
                    disabled="@(selectedCarId == 0 || selectedStationId == 0)"
                    style="
                        padding: 15px 30px;
                        background-color: @(selectedCarId > 0 && selectedStationId > 0 ? "#28a745" : "#ccc");
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 1.2em;
                        cursor: @(selectedCarId > 0 && selectedStationId > 0 ? "pointer" : "not-allowed");
                        font-weight: bold;
                        width: 100%;
                    ">
                ‚ö° Avvia Ricarica
            </button>
            @if (selectedCarId == 0 || selectedStationId == 0)
            {
                <p class="text-muted mt-2 text-center" style="font-size: 0.9em;">
                    @if (selectedStationId == 0)
                    {
                        <span>Seleziona una colonnina per continuare</span>
                    }
                    else if (selectedCarId == 0)
                    {
                        <span>Seleziona un'auto per continuare</span>
                    }
                </p>
            }
        </div>
    }
    else if (requested || currentCharging != null)
    {
        <div style="padding: 15px; background-color: #c8e6c9; border-radius: 5px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
            <p style="color: #2e7d32; font-weight: bold; margin: 0;">‚úÖ Ricarica in corso! Il sistema sta gestendo il processo automaticamente.</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <div style="
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            border-left: 4px solid @(isError ? "#f44336" : "#4caf50");
            background-color: @(isError ? "#ffebee" : "#c8e6c9");
            color: @(isError ? "#c62828" : "#2e7d32");
        ">
            @message
        </div>
    }
</div>

@code {
    [Inject] AuthStateService AuthState { get; set; } = default!;
    
    bool requested;
    ChargingRequestDto? currentCharging;
    int selectedCarId;
    int selectedStationId;
    List<CarDto>? cars;
    List<ParkingSpotDto>? stations;
    CarDto? selectedCar;
    ParkingSpotDto? selectedStation;
    string message = "";
    bool isError = false;
    System.Threading.Timer? chargingTimer;

    protected override async Task OnInitializedAsync()
    {
        // Assicurati che il token sia caricato
        if (!AuthState.IsAuthenticated)
        {
            await AuthState.LoadTokenAsync();
            await Task.Delay(500); // Piccolo delay per assicurare che il token sia stato salvato
        }

        Console.WriteLine($"Token caricato: {(AuthState.IsAuthenticated ? "S√¨" : "No")}");
        
        cars = await Api.GetCars();
        Console.WriteLine($"Auto caricate: {cars?.Count ?? 0}");
        
        stations = await Api.GetPublicStations();
        Console.WriteLine($"Stazioni caricate: {stations?.Count ?? 0}");
        
        currentCharging = await Api.GetCurrentChargingRequest();
        Console.WriteLine($"Ricarica attiva: {(currentCharging != null ? "S√¨" : "No")}");
        
        // Se nessuna stazione, riprova una volta
        if (stations?.Count == 0)
        {
            Console.WriteLine("Nessuna stazione trovata, ritento...");
            await Task.Delay(1000);
            stations = await Api.GetPublicStations();
            Console.WriteLine($"Stazioni dopo retry: {stations?.Count ?? 0}");
        }
        
        // Avvia il polling della ricarica se c'√® una ricarica in corso
        if (currentCharging != null)
        {
            StartChargingPolling();
        }

        // Inizializza la mappa dopo aver caricato i dati
        StateHasChanged(); // Forza il re-render
        await Task.Delay(100); // Piccolo delay per assicurare che il DOM sia aggiornato
        await InitMapAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // La mappa viene inizializzata in OnInitializedAsync dopo aver caricato i dati
        // Non fare nulla qui per evitare doppia inizializzazione
    }

    async Task ReloadStations()
    {
        stations = await Api.GetPublicStations();
        await InitMapAsync();
    }

    async Task InitMapAsync()
    {
        try
        {
            Console.WriteLine($"InitMapAsync - stations: {stations?.Count ?? 0}");
            
            if (stations == null || stations.Count == 0)
            {
                Console.WriteLine("Nessuna stazione da mostrare sulla mappa");
                return;
            }

            var jsStations = new List<object>();
            foreach (var s in stations)
            {
                Console.WriteLine($"Stazione {s.Id}: Lat={s.Latitude}, Lng={s.Longitude}, Name={s.Name}");
                jsStations.Add(new
                {
                    name = string.IsNullOrWhiteSpace(s.Name) ? (string.IsNullOrWhiteSpace(s.Address) ? $"Colonnina #{s.Id}" : s.Address) : s.Name,
                    status = s.IsOccupied ? "Occupata" : "Disponibile",
                    lat = s.Latitude,
                    lng = s.Longitude
                });
            }

            Console.WriteLine($"Chiamando initMap con {jsStations.Count} stazioni");
            await JS.InvokeVoidAsync("initMap", jsStations);
            Console.WriteLine("initMap chiamato con successo");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore inizializzazione mappa: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    void SelectCar(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int carId))
        {
            selectedCarId = carId;
            selectedCar = cars?.FirstOrDefault(c => c.Id == carId);
        }
    }

    void SelectStation(ParkingSpotDto station)
    {
        if (station.IsOccupied) return;
        selectedStationId = station.Id;
        selectedStation = station;
        // Reset della selezione auto quando si cambia colonnina
        selectedCarId = 0;
        selectedCar = null;
    }

    async Task Request()
    {
        if (selectedCarId == 0 || selectedStationId == 0)
        {
            message = "‚ùå Seleziona un'auto e una colonnina prima di continuare";
            isError = true;
            return;
        }

        var ok = await Api.RequestCharging(selectedCarId, selectedCar?.TargetChargePercent ?? 100, selectedStationId);
        if (ok)
        {
            requested = true;
            currentCharging = await Api.GetCurrentChargingRequest();
            var stationName = stations?.FirstOrDefault(s => s.Id == selectedStationId)?.Name ?? $"Colonnina #{selectedStationId}";
            message = $"‚úÖ Ricarica avviata con successo per {selectedCar?.Model} presso {stationName}";
            isError = false;
            StartChargingPolling();
        }
        else
        {
            message = "‚ùå Errore durante la prenotazione della ricarica";
            isError = true;
        }
    }

    async Task StopCharging()
    {
        if (currentCharging == null) return;

        var ok = await Api.StopCharging(currentCharging.CarId);
        if (ok)
        {
            message = "‚úÖ Ricarica terminata manualmente";
            isError = false;
            StopChargingPolling();
            currentCharging = null;
            requested = false;
            stations = await Api.GetPublicStations();
            cars = await Api.GetCars();
            StateHasChanged();
        }
        else
        {
            message = "‚ùå Errore durante l'arresto della ricarica";
            isError = true;
        }
    }

    void StartChargingPolling()
    {
        StopChargingPolling();
        chargingTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                var updatedCharging = await Api.GetCurrentChargingRequest();
                if (updatedCharging == null && currentCharging != null)
                {
                    // La ricarica √® completata
                    StopChargingPolling();
                    message = "üéâ Ricarica completata! La batteria √® stata caricata con successo.";
                    isError = false;
                    currentCharging = null;
                    requested = false;
                    stations = await Api.GetPublicStations();
                    cars = await Api.GetCars();
                    StateHasChanged();
                }
                else if (updatedCharging != null)
                {
                    currentCharging = updatedCharging;
                    StateHasChanged();
                }
            });
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    void StopChargingPolling()
    {
        chargingTimer?.Dispose();
        chargingTimer = null;
    }

    public void Dispose()
    {
        StopChargingPolling();
    }
}
