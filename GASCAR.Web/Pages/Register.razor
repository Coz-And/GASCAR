@page "/register"
@using GASCAR.Web.Models
@using GASCAR.Web.Services
@using Microsoft.AspNetCore.Components.Forms

@inject ApiService Api
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
    <h2>üìù Registrazione</h2>
    
    <!-- PULSANTE DI TEST in cima -->
    <div style="margin-bottom: 20px; padding: 10px; background-color: yellow; border: 3px solid black;">
        <button type="button" style="width: 100%; padding: 20px; background-color: red; color: white; border: 5px solid black; border-radius: 10px; cursor: pointer; font-size: 24px; font-weight: bold;" @onclick="Submit" onclick="alert('HTML onclick works!')">
            üö® REGISTRATI (TEST) üö®
        </button>
    </div>
    
    @if (error != null)
    {
        <div style="color: red; margin-bottom: 10px; padding: 10px; background-color: #ffe6e6; border-radius: 4px;">
            @error
        </div>
    }

    @if (success)
    {
        <div style="color: green; margin-bottom: 10px; padding: 10px; background-color: #e6ffe6; border-radius: 4px;">
            ‚úÖ Registrazione completata! Ora puoi accedere con le tue credenziali.
        </div>
    }

    <EditForm Model="model" OnValidSubmit="Submit">
        <div style="margin-bottom: 15px;">
            <label for="email">Email:</label>
            <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="tuaemail@example.com" style="width: 100%; padding: 8px; margin-top: 5px;" />
        </div>

        <div style="margin-bottom: 15px;">
            <label for="password">Password:</label>
            <InputText id="password" @bind-Value="model.Password" type="password" class="form-control" placeholder="Password sicura" style="width: 100%; padding: 8px; margin-top: 5px;" />
        </div>

        <div style="margin-bottom: 15px;">
            <label for="confirmPassword">Conferma Password:</label>
            <input id="confirmPassword" type="password" class="form-control" @bind="confirmPassword" placeholder="Ripeti la password" style="width: 100%; padding: 8px; margin-top: 5px;" />
        </div>

        @if (model.Password != confirmPassword)
        {
            <div style="color: orange; margin-bottom: 10px; font-size: 0.9em;">
                ‚ö†Ô∏è Le password non coincidono
            </div>
        }

        <button type="button" class="btn btn-primary" style="width: 100%; padding: 15px; background-color: red; color: white; border: 2px solid black; border-radius: 4px; cursor: pointer; font-size: 18px; font-weight: bold;" @onclick="Submit" onclick="alert('HTML onclick works!')">
            @if (isLoading)
            {
                <span>‚è≥ Registrazione in corso...</span>
            }
            else
            {
                <span>REGISTRATI (TEST)</span>
            }
        </button>
    </EditForm>

    <div style="text-align: center; margin-top: 15px;">
        <p>Hai gi√† un account? <a href="/login" style="color: #007bff; text-decoration: none;">Accedi qui</a></p>
    </div>
</div>

@code {
    RegisterDto model = new();
    string? error;
    string confirmPassword = "";
    bool isLoading = false;
    bool success = false;

    async Task Submit()
    {
        // Debug alert - mostra che il metodo viene chiamato
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("alert", "Submit method called!");
        
        Console.WriteLine("üî• Submit method called!");
        
        if (model.Password != confirmPassword)
        {
            error = "Le password non coincidono";
            Console.WriteLine("‚ùå Password mismatch");
            return;
        }

        if (string.IsNullOrEmpty(model.Email) || string.IsNullOrEmpty(model.Password))
        {
            error = "Email e password sono obbligatori";
            Console.WriteLine("‚ùå Missing email or password");
            return;
        }

        if (model.Password.Length < 6)
        {
            error = "La password deve avere almeno 6 caratteri";
            Console.WriteLine("‚ùå Password too short");
            return;
        }

        error = null;
        success = false;
        isLoading = true;
        Console.WriteLine("üöÄ Starting registration...");

        try
        {
            var ok = await Api.Register(model);
            Console.WriteLine($"üì° API response: {ok}");

            if (ok)
            {
                success = true;
                model = new();
                confirmPassword = "";
                Console.WriteLine("‚úÖ Registration successful, redirecting to login...");
                await Task.Delay(2000);
                Nav.NavigateTo("/login");
            }
            else
            {
                error = "Questo email √® gi√† registrato";
                Console.WriteLine("‚ùå Email already exists");
            }
        }
        catch (Exception ex)
        {
            error = $"Errore: {ex.Message}";
            Console.WriteLine($"üí• Exception: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            Console.WriteLine("üèÅ Submit method finished");
        }
    }
}
