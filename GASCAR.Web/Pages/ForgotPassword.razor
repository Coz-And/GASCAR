@page "/forgot-password"
@using GASCAR.Web.Services

@inject ApiService Api
@inject NavigationManager Nav

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
    <h2>Ripristina Password</h2>

    @if (message != null)
    {
        <div style="color: @messageColor; margin-bottom: 10px; padding: 10px; background-color: @backgroundColor; border-radius: 4px;">
            @message
        </div>
    }

    @if (!submitted)
    {
        <p>Inserisci il tuo indirizzo email per ricevere le istruzioni per il ripristino della password.</p>

        <EditForm Model="model" OnValidSubmit="Submit">
            <div style="margin-bottom: 15px;">
                <label for="email">Email:</label>
                <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="tuaemail@example.com" style="width: 100%; padding: 8px; margin-top: 5px;" />
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>‚è≥ Invio in corso...</span>
                }
                else
                {
                    <span>Invia istruzioni</span>
                }
            </button>
        </EditForm>
    }
    else
    {
        <p>Le istruzioni per il ripristino sono state inviate al tuo indirizzo email. Controlla la tua casella di posta.</p>
        <button @onclick="BackToLogin" class="btn btn-secondary" style="width: 100%; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Torna al Login</button>
    }

    <div style="text-align: center; margin-top: 15px;">
        <p>Ricordi la password? <a href="/login" style="color: #007bff; text-decoration: none;">Accedi</a></p>
    </div>
</div>

@code {
    public class ForgotPasswordModel
    {
        public string Email { get; set; } = "";
    }

    ForgotPasswordModel model = new();
    string? message;
    string messageColor = "red";
    string backgroundColor = "#ffe6e6";
    bool isLoading = false;
    bool submitted = false;

    async Task Submit()
    {
        message = null;
        isLoading = true;

        try
        {
            var ok = await Api.ForgotPassword(model.Email);

            if (ok)
            {
                submitted = true;
            }
            else
            {
                message = "Errore nell'invio delle istruzioni. Riprova.";
                messageColor = "red";
                backgroundColor = "#ffe6e6";
            }
        }
        catch (Exception ex)
        {
            message = $"Errore: {ex.Message}";
            messageColor = "red";
            backgroundColor = "#ffe6e6";
        }
        finally
        {
            isLoading = false;
        }
    }

    void BackToLogin()
    {
        Nav.NavigateTo("/login");
    }
}