@page "/ricarica"
@using GASCAR.Web.Services
@using GASCAR.Web.Models

@inject ApiService Api
@inject NavigationManager Nav
@inject NavigationManager Navigation

<div class="container mt-4">
    <h2>‚ö° Ricarica</h2>

    <!-- Info Box -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-radius: 8px; border-left: 4px solid #0066cc;">
        <h5 style="color: #003366;">‚ÑπÔ∏è Come funziona</h5>
        <p style="color: #003366; margin: 0;">Seleziona una colonnina disponibile e avvia la ricarica della tua auto. Il sistema monitora il processo in tempo reale.</p>
    </div>

    @if (currentCharging != null)
    {
        <div class="alert alert-success">
            <strong>Hai una ricarica attiva!</strong><br />
            Auto: @currentCharging.CarId<br />
            Colonnina: @currentCharging.StationId<br />
            Fine stimata: @(currentCharging.EndTime?.ToString("dd/MM/yyyy HH:mm") ?? "-")
        </div>
    }
    else if (cars == null)
    {
        <p style="color: #666;">Caricamento auto...</p>
    }
    else if (cars.Count == 0)
    {
        <div style="padding: 15px; background-color: #fff3cd; border-radius: 5px; border-left: 4px solid #ff9800;">
            <p style="color: #856404; margin: 0;">‚ùå Nessuna auto registrata. Aggiungi un'auto nel tuo profilo.</p>
        </div>
    }
    else
    {
        <!-- Selezione Auto -->
        <div class="mb-4">
            <label class="form-label" style="color: #333; font-weight: bold;">Seleziona Auto:</label>
            <select class="form-control" @onchange="SelectCar" style="font-size: 1em; padding: 10px; border: 2px solid #007bff;">
                <option value="">-- Scegli un'auto --</option>
                @foreach (var car in cars)
                {
                    <option value="@car.Id">@car.Model (@car.CurrentChargePercent%)</option>
                }
            </select>
        </div>

        @if (selectedCarId > 0)
        {
            <!-- Informazioni Auto Selezionata -->
            <div style="padding: 15px; background-color: #e8f5e9; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                <h6 style="color: #2e7d32; margin-top: 0;">‚úÖ Auto Selezionata</h6>
                @if (selectedCar != null)
                {
                    <div style="color: #2e7d32;">
                        <p><strong>Modello:</strong> @selectedCar.Model</p>
                        <p><strong>Carica Attuale:</strong> @selectedCar.CurrentChargePercent%</p>
                        <p><strong>Capacit√† Batteria:</strong> @selectedCar.BatteryCapacityKw kWh</p>
                    </div>
                }
            </div>

            <!-- Selezione Colonnina -->
            <div class="mb-4">
                <h5 style="color: #333;">üîå Seleziona Colonnina</h5>
                @if (stations == null)
                {
                    <p style="color: #666;">Caricamento colonnine...</p>
                }
                else if (stations.Count == 0)
                {
                    <div style="padding: 15px; background-color: #ffebee; border-radius: 5px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; margin: 0;">‚ùå Nessuna colonnina disponibile al momento.</p>
                    </div>
                }
                else
                {
                    <div class="row">
                        @foreach (var station in stations)
                        {
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div style="
                                    padding: 15px;
                                    border: 2px solid @(selectedStationId == station.Id ? "#4caf50" : "#ddd");
                                    border-radius: 8px;
                                    cursor: pointer;
                                    background-color: @(selectedStationId == station.Id ? "#f1f8e9" : "#fff");
                                    transition: all 0.3s ease;
                                "
                                     @onclick="() => SelectStation(station)">
                                    
                                    <div style="color: #1976d2; font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">
                                        üìç Colonnina #@station.Id
                                    </div>

                                    <div style="color: #424242; margin-bottom: 8px;">
                                        <strong style="color: #333;">Indirizzo:</strong> @(string.IsNullOrEmpty(station.Address) ? "Non specificato" : station.Address)
                                    </div>

                                    <div style="
                                        padding: 8px;
                                        border-radius: 5px;
                                        margin-bottom: 8px;
                                        @(!station.IsOccupied ? "background-color: #c8e6c9; color: #2e7d32;" : "background-color: #ffccbc; color: #d84315;")
                                    ">
                                        <strong>Stato:</strong>
                                        @if (!station.IsOccupied)
                                        {
                                            <span>‚úÖ Disponibile</span>
                                        }
                                        else
                                        {
                                            <span>‚è≥ Occupata</span>
                                        }
                                    </div>

                                    @if (selectedStationId == station.Id)
                                    {
                                        <div style="padding: 8px; background-color: #4caf50; color: white; border-radius: 5px; text-align: center; font-weight: bold;">
                                            ‚úì Selezionata
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Pulsante Avvia Ricarica -->
            @if (!requested)
            {
                <button @onclick="Request"
                        disabled="@(selectedCarId == 0 || selectedStationId == 0)"
                        style="
                            padding: 12px 24px;
                            background-color: @(selectedCarId > 0 && selectedStationId > 0 ? "#28a745" : "#ccc");
                            color: white;
                            border: none;
                            border-radius: 5px;
                            font-size: 1.1em;
                            cursor: @(selectedCarId > 0 && selectedStationId > 0 ? "pointer" : "not-allowed");
                            font-weight: bold;
                        ">
                    Avvia Ricarica
                </button>
            }
            else
            {
                <div style="padding: 15px; background-color: #c8e6c9; border-radius: 5px; border-left: 4px solid #4caf50;">
                    <p style="color: #2e7d32; font-weight: bold; margin: 0;">‚úÖ Ricarica prenotata! Il sistema sta gestendo il processo automaticamente.</p>
                </div>
            }

            @if (!string.IsNullOrEmpty(message))
            {
                <div style="
                    padding: 15px;
                    margin-top: 15px;
                    border-radius: 5px;
                    border-left: 4px solid @(isError ? "#f44336" : "#4caf50");
                    background-color: @(isError ? "#ffebee" : "#c8e6c9");
                    color: @(isError ? "#c62828" : "#2e7d32");
                ">
                    @message
                </div>
            }
        }
    }
</div>

@code {
    bool requested;
    ChargingRequestDto? currentCharging;
    int selectedCarId;
    int selectedStationId;
    List<CarDto>? cars;
    List<ParkingSpotDto>? stations;
    CarDto? selectedCar;
    ParkingSpotDto? selectedStation;
    string message = "";
    bool isError = false;

    protected override async Task OnInitializedAsync()
    {
        cars = await Api.GetCars();
        stations = await Api.GetPublicStations();
        currentCharging = await Api.GetCurrentChargingRequest();

        // Support navigation from Map.razor with query params
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (query["stationId"] != null && int.TryParse(query["stationId"], out int stId))
        {
            selectedStationId = stId;
            selectedStation = stations?.FirstOrDefault(s => s.Id == stId);
        }
        if (query["battery"] != null && double.TryParse(query["battery"], out double percent))
        {
            if (selectedCar != null)
                selectedCar.CurrentChargePercent = percent;
        }
    }

    void SelectCar(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int carId))
        {
            selectedCarId = carId;
            selectedCar = cars?.FirstOrDefault(c => c.Id == carId);
        }
    }

    void SelectStation(ParkingSpotDto station)
    {
        selectedStationId = station.Id;
        selectedStation = station;
    }

    async Task Request()
    {
        if (selectedCarId == 0 || selectedStationId == 0)
        {
            message = "‚ùå Seleziona un'auto e una colonnina prima di continuare";
            isError = true;
            return;
        }

        var ok = await Api.RequestCharging(selectedCarId);
        if (ok)
        {
            requested = true;
            message = $"‚úÖ Ricarica avviata con successo per {selectedCar?.Model} presso Colonnina #{selectedStationId}";
            isError = false;
        }
        else
        {
            message = "‚ùå Errore durante la prenotazione della ricarica";
            isError = true;
        }
    }
}
