@page "/admin/hub"
@using GASCAR.Web.Services
@using GASCAR.Web.Models
@inject AuthStateService AuthState
@inject ApiService Api
@inject NavigationManager Navigation

@if (!AuthState.IsAuthenticated)
{
    <div class="text-center mt-5">
        <h4>Accesso richiesto</h4>
        <a href="/login" class="btn btn-primary">Accedi</a>
    </div>
}
else
{
    <div class="container-fluid mt-4">
        <h2 class="mb-4">üîß Dashboard Admin Completa</h2>

        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="stations-tab" data-bs-toggle="tab" data-bs-target="#stations" type="button" role="tab" aria-controls="stations" aria-selected="true">
                    üîå Colonnine
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab" aria-controls="transactions" aria-selected="false">
                    üí∞ Transazioni
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button" role="tab" aria-controls="errors" aria-selected="false">
                    ‚ö†Ô∏è Errori
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <!-- TAB COLONNINE -->
            <div class="tab-pane fade show active" id="stations" role="tabpanel" aria-labelledby="stations-tab">
                <div class="mt-4">
                    <h3 class="mb-3">Gestione Colonnine di Ricarica</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" @onclick="() => ShowAddStationModal()">
                                    ‚ûï Aggiungi Colonnina
                                </button>
                                <button type="button" class="btn btn-info" @onclick="RefreshStations">
                                    üîÑ Aggiorna
                                </button>
                            </div>
                        </div>
                    </div>

                    @if (stations == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Caricamento...</span>
                            </div>
                        </div>
                    }
                    else if (!stations.Any())
                    {
                        <div class="alert alert-info">Nessuna colonnina disponibile.</div>
                    }
                    else
                    {
                        <div class="row">
                            @foreach (var station in stations)
                            {
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header @GetStatusColor(station.Status)">
                                            <h5 class="card-title mb-0">@station.Name</h5>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-2">
                                                <strong>üìç Posizione:</strong> @station.Location
                                            </p>
                                            <p class="mb-2">
                                                <strong>Stato:</strong>
                                                <span class="badge bg-@(station.Status == "Disponibile" ? "success" : station.Status == "Occupata" ? "warning" : "danger")">
                                                    @station.Status
                                                </span>
                                            </p>
                                            <div class="mt-3 d-flex gap-2">
                                                <button class="btn btn-sm btn-warning flex-grow-1" @onclick='@(() => ChangeStatus(station, "Manutenzione"))'>
                                                    üîß Manutenzione
                                                </button>
                                                <button class="btn btn-sm btn-success flex-grow-1" @onclick='@(() => ChangeStatus(station, "Disponibile"))'>
                                                    ‚úÖ Disponibile
                                                </button>
                                                <button class="btn btn-sm btn-danger flex-grow-1" @onclick="() => DeleteStation(station)">
                                                    üóëÔ∏è Elimina
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- TAB TRANSAZIONI -->
            <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
                <div class="mt-4">
                    <h3 class="mb-3">Elenco Transazioni</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <input type="text" class="form-control" @bind="userIdFilter" placeholder="Filtra per ID utente..." />
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info" @onclick="RefreshTransactions">
                                üîÑ Aggiorna
                            </button>
                        </div>
                    </div>

                    @if (transactions == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Caricamento...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        var filteredTransactions = string.IsNullOrEmpty(userIdFilter)
                            ? transactions
                            : transactions.Where(t => t.UserId.Contains(userIdFilter, StringComparison.OrdinalIgnoreCase)).ToList();

                        @if (!filteredTransactions.Any())
                        {
                            <div class="alert alert-info">Nessuna transazione trovata.</div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID Utente</th>
                                            <th>Tipo</th>
                                            <th>Importo (‚Ç¨)</th>
                                            <th>Data</th>
                                            <th>Stato</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var transaction in filteredTransactions.OrderByDescending(t => t.Date))
                                        {
                                            <tr>
                                                <td><strong>@transaction.UserId</strong></td>
                                                <td>@transaction.Type</td>
                                                <td class="fw-bold">‚Ç¨@transaction.Amount.ToString("F2")</td>
                                                <td>@transaction.Date.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>
                                                    <span class="badge bg-@(transaction.Status == "Completata" ? "success" : transaction.Status == "In Sospeso" ? "warning" : "danger")">
                                                        @transaction.Status
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- TAB ERRORI -->
            <div class="tab-pane fade" id="errors" role="tabpanel" aria-labelledby="errors-tab">
                <div class="mt-4">
                    <h3 class="mb-3">Errori Colonnine</h3>
                    
                    <div class="mb-4">
                        <button class="btn btn-warning" @onclick="RefreshErrors">
                            üîÑ Aggiorna Errori
                        </button>
                    </div>

                    @if (stationErrors == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Caricamento errori...</span>
                            </div>
                        </div>
                    }
                    else if (!stationErrors.Any())
                    {
                        <div class="alert alert-success" role="alert">
                            ‚úÖ <strong>Nessun errore!</strong> Tutte le colonnine funzionano correttamente.
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            @foreach (var error in stationErrors)
                            {
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card border-danger h-100 shadow-sm">
                                        <div class="card-header bg-danger text-white">
                                            <h5 class="card-title mb-0">‚ö†Ô∏è @error.StationName</h5>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-2">
                                                <strong>Tipo Errore:</strong>
                                                <span class="badge bg-warning">@error.ErrorType</span>
                                            </p>
                                            <p class="mb-2">
                                                <strong>Descrizione:</strong>
                                                <br />@error.Description
                                            </p>
                                            <p class="mb-3">
                                                <strong>Rilevato:</strong>
                                                <br />@error.DetectedAt.ToString("dd/MM/yyyy HH:mm:ss")
                                            </p>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-success flex-grow-1" @onclick="() => ResolveError(error)">
                                                    ‚úÖ Risolvi
                                                </button>
                                                <button class="btn btn-sm btn-info flex-grow-1" @onclick="() => ViewErrorDetails(error)">
                                                    ‚ÑπÔ∏è Dettagli
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="mt-5 mb-4">
            <a href="/admin" class="btn btn-secondary">‚Üê Torna alla Dashboard</a>
        </div>
    </div>
}

@code {
    private List<ChargingStationDto>? stations;
    private List<AdminTransactionDto>? transactions;
    private List<StationErrorDto>? stationErrors;
    private string userIdFilter = "";
    private bool showAddModal = false;
    private ChargingStationDto newStation = new();
    private string? errorMsg;

    protected override async void OnInitialized()
    {
        if (AuthState.IsAuthenticated)
        {
            await RefreshStations();
            await RefreshTransactions();
            RefreshErrors();
        }
    }

    private async Task RefreshStations()
    {
        try
        {
            stations = await Api.GetStations();
        }
        catch (Exception ex)
        {
            errorMsg = $"Errore caricamento colonnine: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task RefreshTransactions()
    {
        try
        {
            // Carica tutte le transazioni dal server
            transactions = await Api.GetAllAdminTransactions();
        }
        catch (Exception ex)
        {
            errorMsg = $"Errore caricamento transazioni: {ex.Message}";
        }
        StateHasChanged();
    }

    private void RefreshErrors()
    {
        // Mock data con alcuni errori
        stationErrors = new List<StationErrorDto>
        {
            new StationErrorDto 
            { 
                StationName = "Parcheggio Nord", 
                ErrorType = "Connessione Persa", 
                Description = "La colonnina ha perso la connessione con il server centrale.",
                DetectedAt = DateTime.Now.AddHours(-1)
            },
            new StationErrorDto 
            { 
                StationName = "Stazione Sud", 
                ErrorType = "Batteria Bassa", 
                Description = "La batteria di backup della colonnina √® al 15%. Servizio di manutenzione consigliato.",
                DetectedAt = DateTime.Now.AddMinutes(-45)
            }
        };
    }

    private async Task ChangeStatus(ChargingStationDto station, string newStatus)
    {
        if (stations == null) return;
        station.Status = newStatus;
        var idx = stations.IndexOf(station);
        var updated = await Api.UpdateStation(idx+1, station); // Assumendo id = posizione+1, da adattare se serve
        if (updated != null)
        {
            stations[idx] = updated;
        }
        else
        {
            errorMsg = "Errore aggiornamento stato colonnina";
        }
        StateHasChanged();
    }

    private async Task DeleteStation(ChargingStationDto station)
    {
        if (stations == null) return;
        var idx = stations.IndexOf(station);
        var ok = await Api.DeleteStation(idx+1); // Assumendo id = posizione+1, da adattare se serve
        if (ok)
        {
            stations.RemoveAt(idx);
        }
        else
        {
            errorMsg = "Errore eliminazione colonnina";
        }
        StateHasChanged();
    }

    private void ShowAddStationModal()
    {
        newStation = new ChargingStationDto();
        showAddModal = true;
    }

    private async Task AddStation()
    {
        var added = await Api.AddStation(newStation);
        if (added != null)
        {
            stations?.Add(added);
            showAddModal = false;
            newStation = new ChargingStationDto();
        }
        else
        {
            errorMsg = "Errore aggiunta colonnina";
        }
        StateHasChanged();
    }

    private void ResolveError(StationErrorDto error)
    {
        stationErrors?.Remove(error);
        StateHasChanged();
    }

    private void ViewErrorDetails(StationErrorDto error)
    {
        Console.WriteLine($"Dettagli errore: {error.StationName}");
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Disponibile" => "bg-success text-white",
            "Occupata" => "bg-warning text-dark",
            "Manutenzione" => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }

}

// --- MODALE AGGIUNGI COLONNINA ---
@if (showAddModal)
{
    <div class="modal show d-block" tabindex="-1" style="background:rgba(0,0,0,0.3);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aggiungi Colonnina</h5>
                    <button type="button" class="btn-close" @onclick="() => showAddModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Nome</label>
                        <input class="form-control" @bind="newStation.Name" />
                    </div>
                    <div class="mb-3">
                        <label>Stato</label>
                        <select class="form-control" @bind="newStation.Status">
                            <option value="Disponibile">Disponibile</option>
                            <option value="Occupata">Occupata</option>
                            <option value="Manutenzione">Manutenzione</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Posizione</label>
                        <input class="form-control" @bind="newStation.Location" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => showAddModal = false">Annulla</button>
                    <button class="btn btn-primary" @onclick="AddStation">Aggiungi</button>
                </div>
            </div>
        </div>
    </div>
}
