@page "/login"
@using GASCAR.Web.Models
@using GASCAR.Web.Services

@inject ApiService Api
@inject NavigationManager Nav

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
    <h2>Login</h2>
    
    @if (error != null)
    {
        <div style="color: red; margin-bottom: 10px; padding: 10px; background-color: #ffe6e6; border-radius: 4px;">
            @error
        </div>
    }

    <EditForm Model="model" OnValidSubmit="Submit">
        <div style="margin-bottom: 15px;">
            <label for="email">Email:</label>
            <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="tuaemail@example.com" style="width: 100%; padding: 8px; margin-top: 5px;" />
        </div>

        <div style="margin-bottom: 15px;">
            <label for="password">Password:</label>
            <InputText id="password" @bind-Value="model.Password" type="password" class="form-control" placeholder="Password" style="width: 100%; padding: 8px; margin-top: 5px;" />
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled="@isLoading">
            @if (isLoading)
            {
                <span>‚è≥ Accesso in corso...</span>
            }
            else
            {
                <span>Accedi</span>
            }
        </button>
    </EditForm>

    <div style="text-align: center; margin-top: 15px;">
        <p><a href="/forgot-password" style="color: #007bff; text-decoration: none;">Hai dimenticato la password?</a></p>
        <p>Non hai un account? <a href="/register" style="color: #007bff; text-decoration: none;">Registrati qui</a></p>
    </div>
</div>

@code {
    LoginDto model = new();
    string? error;
    bool isLoading = false;

    async Task Submit()
    {
        error = null;
        isLoading = true;

        try
        {
            var ok = await Api.Login(model);

            if (ok)
            {
                // Semplice check: se l'email contiene 'admin' vai su /admin/hub, altrimenti su /
                if (!string.IsNullOrEmpty(model.Email) && model.Email.ToLower().Contains("admin"))
                {
                    Nav.NavigateTo("/admin/hub");
                }
                else
                {
                    Nav.NavigateTo("/");
                }
            }
            else
            {
                error = "Email o password errati";
            }
        }
        catch (Exception ex)
        {
            error = $"Errore: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
